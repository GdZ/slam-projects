# Automatically generated by Zserio Python extension version 2.12.0.
# Generator setup: writerCode, pubsubCode, serviceCode, sqlCode

from __future__ import annotations

import typing
import apsw

import nds.core.types.packed_tile_id
import nds.smart.tile.smart_layer_tile
import nds.smart.types.smart_layer_header
import zserio

class SmartLayerTileTable:
    class Rows:
        def __init__(self, rows: typing.Iterator[typing.Tuple]) -> None:
            self._rows = rows

        def __iter__(self) -> typing.Iterator['SmartLayerTileTable.ROW_ANNOTATION']:
            for row in self._rows:
                yield self._read_row(row)

        @staticmethod
        def _read_row(row: typing.Tuple) -> 'SmartLayerTileTable.ROW_ANNOTATION':
            tile_id_ = row[0]
            smart_layer_ = row[1]
            if smart_layer_ is not None:
                reader = zserio.BitStreamReader(smart_layer_)
                smart_layer_ = nds.smart.tile.smart_layer_tile.SmartLayerTile.from_reader(reader)
            header_ = row[2]
            if header_ is not None:
                reader = zserio.BitStreamReader(header_)
                header_ = nds.smart.types.smart_layer_header.SmartLayerHeader.from_reader(reader)

            return (tile_id_, smart_layer_, header_)

    def __init__(self, connection: apsw.Connection, table_name: str, attached_db_name: str = None) -> None:
        self._connection: apsw.Connection = connection
        self._table_name: str = table_name
        self._attached_db_name: str = attached_db_name

    def create_table(self) -> None:
        sql_query = self._get_create_table_query()
        cursor = self._connection.cursor()
        cursor.execute(sql_query)

    def delete_table(self) -> None:
        sql_query = "DROP TABLE "
        sql_query += self._get_table_name_in_query()
        cursor = self._connection.cursor()
        cursor.execute(sql_query)

    def read(self, condition: str = None) -> 'SmartLayerTileTable.Rows':
        sql_query = ("SELECT "
                    "tileId, "
                    "smartLayer, "
                    "header"
                    " FROM ")
        sql_query += self._get_table_name_in_query()
        if condition:
            sql_query += " WHERE " + condition

        cursor = self._connection.cursor()
        read_rows = cursor.execute(sql_query)

        return SmartLayerTileTable.Rows(read_rows)

    def write(self, rows: typing.Sequence['SmartLayerTileTable.ROW_ANNOTATION']) -> None:
        sql_query = "INSERT INTO "
        sql_query += self._get_table_name_in_query()
        sql_query += ("("
                     "tileId, "
                     "smartLayer, "
                     "header"
                     ") VALUES (?, ?, ?)")

        cursor = self._connection.cursor()
        has_autocommit = self._connection.getautocommit()
        if has_autocommit:
            cursor.execute("BEGIN")

        for row in rows:
            cursor.execute(sql_query, self._write_row(row))

        if has_autocommit:
            cursor.execute("COMMIT")

    def update(self, row: 'SmartLayerTileTable.ROW_ANNOTATION', where_condition: str) -> None:
        sql_query = "UPDATE "
        sql_query += self._get_table_name_in_query()
        sql_query += (" SET"
                     " tileId=?,"
                     " smartLayer=?,"
                     " header=?"
                     " WHERE ") + where_condition

        cursor = self._connection.cursor()
        cursor.execute(sql_query, self._write_row(row))

    def _get_table_name_in_query(self) -> str:
        return (self._attached_db_name + "." + self._table_name) if self._attached_db_name else self._table_name

    def _get_create_table_query(self) -> str:
        sql_query = "CREATE TABLE "
        sql_query += self._get_table_name_in_query()
        sql_query += ("(" +
                     "tileId INTEGER" + " " + "PRIMARY KEY NOT NULL" + "," +
                     "smartLayer BLOB" + " " + "NOT NULL" + "," +
                     "header BLOB" + " " + "NULL" +
                     ")")

        return sql_query

    @staticmethod
    def _write_row(row: 'SmartLayerTileTable.ROW_ANNOTATION') -> typing.List:
        row_in_list : typing.List = list(row)

        smart_layer_ = row_in_list[1]
        if isinstance(smart_layer_, nds.smart.tile.smart_layer_tile.SmartLayerTile):
            writer = zserio.BitStreamWriter()
            smart_layer_.write(writer)
            row_in_list[1] = writer.byte_array

        header_ = row_in_list[2]
        if isinstance(header_, nds.smart.types.smart_layer_header.SmartLayerHeader):
            writer = zserio.BitStreamWriter()
            header_.write(writer)
            row_in_list[2] = writer.byte_array

        return row_in_list

    ROW_ANNOTATION = typing.Tuple[
        nds.core.types.packed_tile_id.PackedTileId,
        nds.smart.tile.smart_layer_tile.SmartLayerTile,
        nds.smart.types.smart_layer_header.SmartLayerHeader]
