/**
 * Automatically generated by Zserio Java extension version 2.12.0.
 * Generator setup: writerCode, pubsubCode, serviceCode, sqlCode.
 */

package nds.smart.filestore;

public class SmartLayerTileStore implements zserio.runtime.SqlDatabase
{
    public SmartLayerTileStore(java.lang.String fileName) throws java.sql.SQLException
    {
        this(fileName, new java.util.HashMap<java.lang.String, java.lang.String>());
    }

    public SmartLayerTileStore(java.lang.String fileName,
            java.util.Map<java.lang.String, java.lang.String> tableToDbFileNameRelocationMap)
            throws java.sql.SQLException
    {
        final java.util.Properties connectionProps = new java.util.Properties();
        connectionProps.setProperty("flags", "CREATE");
        final java.lang.String uriPath = "jdbc:sqlite:" + new java.io.File(fileName).toString();

        connection = java.sql.DriverManager.getConnection(uriPath, connectionProps);
        isExternal = false;
        attachedDbList = new java.util.ArrayList<java.lang.String>();

        final java.util.Map<java.lang.String, java.lang.String> tableToAttachedDbNameRelocationMap =
                new java.util.HashMap<java.lang.String, java.lang.String>();
        final java.util.Map<java.lang.String, java.lang.String> dbFileNameToAttachedDbNameMap =
                new java.util.HashMap<java.lang.String, java.lang.String>();
        for (java.util.Map.Entry<java.lang.String, java.lang.String> entry :
                tableToDbFileNameRelocationMap.entrySet())
        {
            final java.lang.String relocatedTableName = entry.getKey();
            final java.lang.String dbFileName = entry.getValue();

            java.lang.String attachedDbName = dbFileNameToAttachedDbNameMap.get(dbFileName);
            if (attachedDbName == null)
            {
                attachedDbName = "SmartLayerTileStore" + "_" + relocatedTableName;
                attachDatabase(dbFileName, attachedDbName);
                dbFileNameToAttachedDbNameMap.put(dbFileName, attachedDbName);
            }

            tableToAttachedDbNameRelocationMap.put(relocatedTableName, attachedDbName);
        }

        initTables(tableToAttachedDbNameRelocationMap);
    }

    public SmartLayerTileStore(java.sql.Connection externalConnection)
    {
        this(externalConnection, new java.util.HashMap<java.lang.String, java.lang.String>());
    }

    public SmartLayerTileStore(java.sql.Connection externalConnection,
            java.util.Map<java.lang.String, java.lang.String> tableToAttachedDbNameRelocationMap)
    {
        connection = externalConnection;
        isExternal = true;
        attachedDbList = null;

        initTables(tableToAttachedDbNameRelocationMap);
    }

    @Override
    public void close() throws java.sql.SQLException
    {
        if (!isExternal)
        {
            try
            {
                detachDatabases();
            }
            finally
            {
                connection.close();
            }
        }
    }

    @Override
    public java.sql.Connection connection()
    {
        return connection;
    }

    public nds.smart.filestore.SmartLayerMetadataTable getMetadataTable()
    {
        return this.metadataTable_;
    }

    public nds.smart.filestore.SmartLayerTileTable getTileTable()
    {
        return this.tileTable_;
    }

    @Override
    public void createSchema() throws java.sql.SQLException
    {
        final boolean wasTransactionStarted = startTransaction();

        this.metadataTable_.createTable();
        this.tileTable_.createTable();

        endTransaction(wasTransactionStarted);
    }

    @Override
    public void createSchema(java.util.Set<java.lang.String> withoutRowIdTableNamesBlackList)
            throws java.sql.SQLException
    {
        createSchema();
    }

    @Override
    public void deleteSchema() throws java.sql.SQLException
    {
        final boolean wasTransactionStarted = startTransaction();

        this.metadataTable_.deleteTable();
        this.tileTable_.deleteTable();

        endTransaction(wasTransactionStarted);
    }

    public static java.lang.String databaseName()
    {
        return DATABASE_NAME;
    }

    public static java.lang.String[] tableNames()
    {
        return new java.lang.String[]
        {
            metadataTable_TABLE_NAME,
            tileTable_TABLE_NAME
        };
    }

    private void initTables(java.util.Map<java.lang.String, java.lang.String> tableToAttachedDbNameRelocationMap)
    {
        this.metadataTable_ = new nds.smart.filestore.SmartLayerMetadataTable(connection,
                tableToAttachedDbNameRelocationMap.get(metadataTable_TABLE_NAME),
                metadataTable_TABLE_NAME);
        this.tileTable_ = new nds.smart.filestore.SmartLayerTileTable(connection,
                tableToAttachedDbNameRelocationMap.get(tileTable_TABLE_NAME),
                tileTable_TABLE_NAME);
    }

    private void executeUpdate(java.lang.String sql) throws java.sql.SQLException
    {
        try (final java.sql.Statement statement = connection.createStatement())
        {
            statement.executeUpdate(sql);
        }
    }

    private void attachDatabase(java.lang.String dbFileName, java.lang.String attachedDbName)
            throws java.sql.SQLException
    {
        final java.lang.StringBuilder sqlQuery = new java.lang.StringBuilder("ATTACH DATABASE '");
        sqlQuery.append(new java.io.File(dbFileName).toString());
        sqlQuery.append("' AS ");
        sqlQuery.append(attachedDbName);
        executeUpdate(sqlQuery.toString());

        attachedDbList.add(attachedDbName);
    }

    private void detachDatabases() throws java.sql.SQLException
    {
        for (java.lang.String attachedDbName : attachedDbList)
        {
            final java.lang.String sqlQuery = "DETACH DATABASE " + attachedDbName;
            executeUpdate(sqlQuery);
        }
    }

    private boolean startTransaction() throws java.sql.SQLException
    {
        boolean wasTransactionStarted = false;
        if (connection.getAutoCommit())
        {
            connection.setAutoCommit(false);
            wasTransactionStarted = true;
        }

        return wasTransactionStarted;
    }

    private void endTransaction(boolean wasTransactionStarted) throws java.sql.SQLException
    {
        if (wasTransactionStarted)
        {
            connection.commit();
            connection.setAutoCommit(true);
        }
    }

    private static final java.lang.String DATABASE_NAME = "SmartLayerTileStore";
    private static final java.lang.String metadataTable_TABLE_NAME = "metadataTable";
    private static final java.lang.String tileTable_TABLE_NAME = "tileTable";

    private final java.sql.Connection connection;
    private final boolean isExternal;
    private final java.util.List<java.lang.String> attachedDbList;

    private nds.smart.filestore.SmartLayerMetadataTable metadataTable_;
    private nds.smart.filestore.SmartLayerTileTable tileTable_;
}
