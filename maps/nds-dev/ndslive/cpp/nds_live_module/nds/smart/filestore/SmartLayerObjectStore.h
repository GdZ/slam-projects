/**
 * Automatically generated by Zserio C++ extension version 2.12.0.
 * Generator setup: writerCode, pubsubCode, serviceCode, sqlCode, sourcesAmalgamation, stdAllocator.
 */

#ifndef NDS_SMART_FILESTORE_SMART_LAYER_OBJECT_STORE_H
#define NDS_SMART_FILESTORE_SMART_LAYER_OBJECT_STORE_H

#include <zserio/CppRuntimeVersion.h>
#if CPP_EXTENSION_RUNTIME_VERSION_NUMBER != 2012000
    #error Version mismatch between Zserio runtime library and Zserio compiler!
    #error Please update your Zserio runtime library to the version 2.12.0.
#endif

#include <memory>
#include <array>
#include <set>
#include <zserio/Vector.h>
#include <map>
#include <zserio/Vector.h>
#include <zserio/ArrayTraits.h>
#include <zserio/String.h>
#include <zserio/UniquePtr.h>
#include <zserio/AllocatorHolder.h>
#include <zserio/StringView.h>
#include <zserio/ISqliteDatabase.h>
#include <zserio/SqliteConnection.h>

#include <nds/smart/filestore/SmartLayerMetadataTable.h>
#include <nds/smart/filestore/SmartLayerObjectTable.h>

namespace nds
{
namespace smart
{
namespace filestore
{

class SmartLayerObjectStore : public ::zserio::ISqliteDatabase,
        public ::zserio::AllocatorHolder<::std::allocator<uint8_t>>
{
public:
    using TRelocationMap = ::std::map<::zserio::string<>, ::zserio::string<>>;

    explicit SmartLayerObjectStore(const ::zserio::string<>& dbFileName,
            const TRelocationMap& tableToDbFileNameRelocationMap = TRelocationMap(),
            const allocator_type& allocator = allocator_type());
    explicit SmartLayerObjectStore(const ::zserio::string<>& dbFileName, const allocator_type& allocator);
    explicit SmartLayerObjectStore(sqlite3* externalConnection,
            const TRelocationMap& tableToAttachedDbNameRelocationMap = TRelocationMap(),
            const allocator_type& allocator = allocator_type());
    explicit SmartLayerObjectStore(sqlite3* externalConnection, const allocator_type& allocator);

    ~SmartLayerObjectStore() override;

    SmartLayerObjectStore(const SmartLayerObjectStore&) = delete;
    SmartLayerObjectStore& operator=(const SmartLayerObjectStore&) = delete;

    SmartLayerObjectStore(SmartLayerObjectStore&&) = delete;
    SmartLayerObjectStore& operator=(SmartLayerObjectStore&&) = delete;

    ::zserio::SqliteConnection& connection() noexcept override;

    ::nds::smart::filestore::SmartLayerMetadataTable& getMetadataTable() noexcept;
    ::nds::smart::filestore::SmartLayerObjectTable& getObjectTable() noexcept;

    void createSchema() override;
    void createSchema(const ::std::set<::zserio::string<>>& withoutRowIdTableNamesBlackList);
    void deleteSchema() override;

    static ::zserio::StringView databaseName() noexcept;
    static const ::std::array<::zserio::StringView, 2>& tableNames() noexcept;

private:
    void initTables();
    void attachDatabase(::zserio::StringView fileName, ::zserio::StringView attachedDbName);
    void detachDatabases();

    static ::zserio::StringView tableNameMetadataTable() noexcept;
    static ::zserio::StringView tableNameObjectTable() noexcept;

    ::zserio::SqliteConnection m_db;
    ::zserio::vector<::zserio::string<>> m_attachedDbList;
    TRelocationMap m_tableToAttachedDbNameRelocationMap;

    ::zserio::unique_ptr<::nds::smart::filestore::SmartLayerMetadataTable> m_metadataTable_;
    ::zserio::unique_ptr<::nds::smart::filestore::SmartLayerObjectTable> m_objectTable_;
};

} // namespace filestore
} // namespace smart
} // namespace nds

#endif // NDS_SMART_FILESTORE_SMART_LAYER_OBJECT_STORE_H
